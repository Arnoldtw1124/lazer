{% extends "base.html" %}

{% block title %}訂單管理 - Admin V2{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include 'admin_sidebar.html' %}

    <div class="admin-main">
        <header class="dashboard-header">
            <div>
                <h2 class="glitch" data-text="ORDER MANAGEMENT">ORDER MANAGEMENT</h2>
                <p>訂單查詢與狀態管理</p>
            </div>
            <div class="user-profile">
                <span>ADMINISTRATOR</span>
                <div class="avatar">AD</div>
            </div>
        </header>

        <!-- Filter & Search Bar -->
        <div class="filter-bar">
            <div class="status-filters">
                <button onclick="filterOrders('All')" class="filter-btn active" id="btn-All">全部</button>
                <button onclick="filterOrders('Pending')" class="filter-btn" id="btn-Pending">待確認</button>
                <button onclick="filterOrders('Processing')" class="filter-btn" id="btn-Processing">製作中</button>
                <button onclick="filterOrders('Completed')" class="filter-btn" id="btn-Completed">已完成</button>
                <button onclick="filterOrders('Cancelled')" class="filter-btn" id="btn-Cancelled">已取消</button>
            </div>

            <form action="{{ url_for('admin_orders') }}" method="GET" class="search-form">
                <input type="text" name="search" placeholder="搜尋姓名或訂單號..." value="{{ search_query }}">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>

        <!-- Orders Table -->
        <div class="data-card full-width">
            <div class="recent-orders">
                <table class="cyber-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>顧客姓名</th>
                            <th>商品內容 (材質)</th>
                            <th>訂單狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr class="order-row" data-status="{{ order.status }}">
                            <td>#{{ order.id }}</td>
                            <td>
                                {{ order.name }}
                                <div style="font-size: 0.8rem; color: #666;">{{ order.contact }}</div>
                            </td>
                            <td>
                                {{ order.material }}
                                <div style="font-size: 0.8rem; color: #888;">{{ order.date.strftime('%Y-%m-%d') }}</div>
                            </td>
                            <td>
                                <!-- Inline Status Update -->
                                <form action="{{ url_for('update_status', order_id=order.id) }}" method="POST"
                                    style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <select name="status" onchange="this.form.submit()"
                                        class="status-select status-{{ order.status }}">
                                        <option value="Pending" {% if order.status=='Pending' %}selected{% endif %}>
                                            Pending</option>
                                        <option value="Processing" {% if order.status=='Processing' %}selected{% endif
                                            %}>Processing</option>
                                        <option value="Completed" {% if order.status=='Completed' %}selected{% endif %}>
                                            Completed</option>
                                        <option value="Cancelled" {% if order.status=='Cancelled' %}selected{% endif %}>
                                            Cancelled</option>
                                    </select>
                                    <input type="hidden" name="redirect_to" value="admin_orders">
                                </form>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="toggleDetails('details-{{ order.id }}')" class="btn-icon"
                                        title="查看詳情">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <form method="POST" action="{{ url_for('delete_order', order_id=order.id) }}"
                                        onsubmit="return confirm('確定要刪除訂單 #{{ order.id }} 嗎？此動作無法復原！');"
                                        style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="redirect_to" value="admin_orders">
                                        <button type="submit" class="btn-icon delete" title="刪除訂單">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <!-- Collapsible Details Row -->
                        <tr id="details-{{ order.id }}" class="details-row" style="display: none;">
                            <td colspan="5">
                                <div class="details-content">
                                    <div class="notes-box">
                                        <h4>備註 / 需求</h4>
                                        <p>{{ order.notes if order.notes else '無備註' }}</p>
                                    </div>
                                    {% if order.filename %}
                                    <div class="image-box">
                                        <h4>附檔預覽</h4>
                                        <a href="{{ url_for('static', filename='uploads/' + order.filename) }}"
                                            target="_blank">
                                            <img src="{{ url_for('static', filename='uploads/' + order.filename) }}"
                                                alt="Order Image">
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">沒有找到相關訂單資料。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDetails(id) {
        const row = document.getElementById(id);
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
        } else {
            row.style.display = 'none';
        }
    }

    function filterOrders(status) {
        // 1. Update Buttons
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + status).classList.add('active');

        // 2. Filter Rows
        const rows = document.querySelectorAll('.order-row');
        rows.forEach(row => {
            if (status === 'All' || row.dataset.status === status) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
                // Also hide details row if open
                const nextRow = row.nextElementSibling;
                if (nextRow && nextRow.classList.contains('details-row')) {
                    nextRow.style.display = 'none';
                }
            }
        });
    }

    // Initial Filter Support (Optional, if deep linking needed in future)
    // currently defaults to 'All' via HTML, but checks URL param just in case
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        if (status) {
            filterOrders(status);
        }
    });
</script>

<style>
    /* Reuse layout styles */
    .admin-layout {
        display: flex;
        min-height: 100vh;
        background: #0a0a0c;
        padding-top: 60px;
    }

    .admin-main {
        flex: 1;
        padding: 2rem;
        margin-left: 260px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
    }

    .dashboard-header h2 {
        font-family: 'Orbitron', sans-serif;
        color: white;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        background: rgba(20, 20, 24, 0.6);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-filters {
        display: flex;
        gap: 0.5rem;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #333;
        border-radius: 5px;
        background: transparent;
        /* Fix default button background */
        color: #888;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        /* Add pointer cursor */
    }

    .filter-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        /* White text on purple looks better than black */
        border-color: var(--primary-color);
        box-shadow: 0 0 10px var(--primary-color);
        /* Soft glow */
    }

    .search-form {
        display: flex;
        gap: 0.5rem;
    }

    .search-form input {
        background: #000;
        border: 1px solid #333;
        color: white;
        padding: 0.5rem;
        border-radius: 5px;
        outline: none;
    }

    .search-form button {
        background: var(--secondary-color);
        border: none;
        color: black;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }

    /* Table Styles (Reused & Enhanced) */
    .data-card {
        background: rgba(20, 20, 24, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1.5rem;
    }

    .cyber-table {
        width: 100%;
        border-collapse: collapse;
        color: #ccc;
    }

    .cyber-table th {
        text-align: left;
        padding: 1rem;
        border-bottom: 1px solid #333;
        color: var(--primary-color);
    }

    .cyber-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Status Select */
    .status-select {
        padding: 5px;
        border-radius: 5px;
        background: #000;
        color: white;
        border: 1px solid #333;
        cursor: pointer;
    }

    .status-Pending {
        color: #f1c40f;
        border-color: #f1c40f;
    }

    .status-Processing {
        color: #3498db;
        border-color: #3498db;
    }

    .status-Completed {
        color: #2ecc71;
        border-color: #2ecc71;
    }

    .status-Cancelled {
        color: #e74c3c;
        border-color: #e74c3c;
    }

    /* Details Row */
    .details-content {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 5px;
        display: flex;
        gap: 2rem;
    }

    .notes-box {
        flex: 2;
    }

    .image-box {
        flex: 1;
    }

    .image-box img {
        max-width: 100%;
        border-radius: 5px;
        border: 1px solid #333;
    }

    .btn-icon {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.1rem;
        margin-right: 0.5rem;
    }

    .btn-icon:hover {
        color: var(--secondary-color);
    }

    .btn-icon.delete:hover {
        color: #e74c3c;
    }
</style>
{% endblock %}