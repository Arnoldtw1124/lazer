{% extends 'base.html' %}

{% block title %}ç«‹å³é ç´„ - è«¾é›• ALE{% endblock %}

{% block content %}
<section class="booking-section"
    style="padding: 100px 10%; min-height: 80vh; display: flex; justify-content: center; align-items: center;">
    <div class="booking-card"
        style="background: var(--card-bg); padding: 3rem; border-radius: 20px; border: var(--glass-border); width: 100%; max-width: 600px; backdrop-filter: blur(10px);">

        <!-- Flash Messages Styles -->
        <style>
            .flash-message {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 8px;
                text-align: center;
                border: 1px solid currentColor;
            }

            .flash-success {
                background: rgba(46, 204, 113, 0.2);
                color: #2ecc71;
            }

            .flash-error {
                background: rgba(231, 76, 60, 0.2);
                color: #e74c3c;
            }
        </style>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash-message {{ 'flash-success' if category == 'success' else 'flash-error' }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary-color);">é ç´„é›·é›•æœå‹™</h2>
        <form method="POST" action="{{ url_for('booking') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="name">æš±ç¨± (Nickname)</label>
                <input type="text" id="name" name="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„ç¨±å‘¼"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white;">
            </div>

            <div class="form-group">
                <label for="email">é›»å­éƒµä»¶ (Email) <span style="color: #ff4d4d;">*</span></label>
                <input type="email" id="email" name="email" required placeholder="example@gmail.com"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white;">
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="product" style="display: block; margin-bottom: 0.5rem;">å•†å“é¸æ“‡ (Product Selection)</label>
                <select id="product" name="product" required
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white;"
                    onchange="handleProductChange()">
                    <option value="" disabled {% if not request.args.get('product') %}selected{% endif %}
                        style="color: black;">è«‹é¸æ“‡å•†å“</option>
                    {% for key, p in products.items() %}
                    <option value="{{ p.name }}" {% if request.args.get('product')==p.name %}selected{% endif %}
                        style="color: black;">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Dynamic Variant Section -->
            <div id="variant-section" class="form-group" style="margin-bottom: 1.5rem; display: none;">
                <label for="variant" style="display: block; margin-bottom: 0.5rem;">æ¬¾å¼é¸æ“‡ (Style/Variant)</label>
                <select id="variant" name="variant"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white;">
                    <option value="" disabled selected style="color: black;">è«‹é¸æ“‡æ¬¾å¼</option>
                </select>
            </div>

            <!-- Upload Section (Hidden by default until product is selected) -->
            <div id="upload-section"
                style="display: none; background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border: 1px dashed rgba(255,255,255,0.3);">
                <label for="file"
                    style="display: block; margin-bottom: 1rem; color: var(--secondary-color); font-weight: bold;">
                    ğŸ“‚ ä¸Šå‚³é›·é›•åœ–æª” (Upload File)
                </label>
                <input type="file" id="file" name="file" accept=".jpg,.jpeg,.png,.ai,.svg"
                    style="margin-bottom: 1rem; color: rgba(255,255,255,0.8);">

                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
                    <strong>ğŸ’¡ å»ºè­°è¦æ ¼ï¼š</strong>
                    <ul style="padding-left: 1.2rem; margin-top: 0.5rem;">
                        <li><strong>æ ¼å¼ï¼š</strong> JPG / PNG (é»‘ç™½ç·šç¨¿æœ€ä½³)</li>
                        <li><strong>è§£æåº¦ï¼š</strong> 300dpi ä»¥ä¸Šï¼Œé¿å…é‰…é½’ç‹€ã€‚</li>
                        <li><strong>å‚™è¨»ï¼š</strong> è‹¥åªæœ‰è‰åœ–ï¼Œè«‹åœ¨ä¸‹æ–¹å‚™è¨»æ¬„èªªæ˜ã€‚</li>
                    </ul>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">å‚™è¨»éœ€æ±‚ (Notes)</label>
                <textarea id="notes" name="notes" rows="4" placeholder="è«‹æè¿°æ‚¨çš„è¨­è¨ˆæƒ³æ³•ã€åˆ»å°æ–‡å­—å…§å®¹ç­‰..."
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white; resize: none;"></textarea>
            </div>

            <button type="submit" class="btn btn-primary"
                style="width: 100%; border: none; cursor: pointer;">é€å‡ºé ç´„</button>
        </form>

        <script>
            // Prepare product variant data from backend
            const productVariants = {};
            {% for key, p in products.items() %}
            {% if p.variants %}
            productVariants["{{ p.name }}"] = [
                {% for v in p.variants %}
            "{{ v.name }}",
                {% endfor %}
                ];
            {% endif %}
            {% endfor %}

            function handleProductChange() {
                const productSelect = document.getElementById("product");
                const uploadSection = document.getElementById("upload-section");
                const variantSection = document.getElementById("variant-section");
                const variantSelect = document.getElementById("variant");

                const selectedProduct = productSelect.value;
                const variants = productVariants[selectedProduct];

                // 1. Handle Upload Section Visibility
                if (selectedProduct !== "") {
                    uploadSection.style.display = "block";
                    uploadSection.style.animation = "fadeIn 0.5s";
                } else {
                    uploadSection.style.display = "none";
                }

                // 2. Handle Variant Selection
                variantSelect.innerHTML = '<option value="" disabled selected style="color: black;">è«‹é¸æ“‡æ¬¾å¼</option>'; // Reset

                if (variants && variants.length > 0) {
                    variantSection.style.display = "block";
                    variantSelect.required = true;

                    variants.forEach(v => {
                        const option = document.createElement("option");
                        option.value = v;
                        option.textContent = v;
                        option.style.color = "black";
                        variantSelect.appendChild(option);
                    });
                } else {
                    variantSection.style.display = "none";
                    variantSelect.required = false;
                }
            }

            // Run on load to handle pre-filled data (from URL)
            document.addEventListener("DOMContentLoaded", function () {
                handleProductChange();

                // Pre-select variant if in URL
                const urlParams = new URLSearchParams(window.location.search);
                const variantParam = urlParams.get('variant');
                if (variantParam) {
                    const variantSelect = document.getElementById("variant");
                    // Wait a tick for the select to be populated? No, handleProductChange is synchronous.
                    // But we need to make sure the options are there.
                    // Loop through options to find match
                    for (let i = 0; i < variantSelect.options.length; i++) {
                        if (variantSelect.options[i].value === variantParam) {
                            variantSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            });
        </script>
    </div>
</section>
{% endblock %}