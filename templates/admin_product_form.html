{% extends 'base.html' %}

{% block title %}{% if product %}ç·¨è¼¯å•†å“{% else %}æ–°å¢å•†å“{% endif %} - è«¾é›• ALE{% endblock %}

{% block content %}
<section style="min-height: 100vh; background: #0f0f13; padding: 100px 5%; display: flex; justify-content: center;">

    <div style="width: 100%; max-width: 800px;">
        <div style="margin-bottom: 2rem;">
            <a href="{{ url_for('admin_products') }}" style="color: #aaa; text-decoration: none;">â† è¿”å›åˆ—è¡¨</a>
        </div>

        <h1 style="color: white; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem;">
            {% if product %}ç·¨è¼¯å•†å“: {{ product.name }}{% else %}æ–°å¢å•†å“{% endif %}
        </h1>

        <form method="POST" enctype="multipart/form-data"
            style="background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Styles -->
            <style>
                .admin-section {
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    padding: 25px;
                    margin-bottom: 25px;
                }

                .admin-section h3 {
                    color: var(--secondary-color);
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    font-size: 1.2rem;
                }

                .form-grid {
                    display: grid;
                    grid-template-columns: 140px 1fr;
                    gap: 20px;
                    margin-bottom: 20px;
                    align-items: start;
                }

                .form-label {
                    text-align: right;
                    color: #aaa;
                    padding-top: 10px;
                    font-weight: bold;
                }

                .form-label span.required {
                    color: #e74c3c;
                    margin-left: 4px;
                }

                /* Switch CSS */
                .switch {
                    position: relative;
                    display: inline-block;
                    width: 50px;
                    height: 24px;
                }

                .switch input {
                    display: none;
                }

                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #333;
                    transition: .4s;
                    border-radius: 34px;
                }

                .slider:before {
                    position: absolute;
                    content: "";
                    height: 16px;
                    width: 16px;
                    left: 4px;
                    bottom: 4px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }

                input:checked+.slider {
                    background-color: var(--secondary-color);
                }

                input:checked+.slider.red-slider {
                    background-color: #e74c3c;
                }

                input:checked+.slider:before {
                    transform: translateX(26px);
                }
            </style>

            <!-- Section: Basic Settings -->
            <div class="admin-section">
                <h3>åŸºæœ¬è¨­å®š (Basic Info)</h3>

                <!-- Image -->
                <div class="form-grid">
                    <div class="form-label">å•†å“åœ–ç‰‡ <span class="required">*</span></div>
                    <div>
                        {% if product and product.image %}
                        <div style="margin-bottom: 10px;">
                            <img id="preview-image" src="{{ url_for('static', filename='images/' + product.image) }}"
                                data-fallback="{{ url_for('static', filename='uploads/' + (product.image if product else 'default_product.jpg')) }}"
                                style="max-width: 150px; border-radius: 5px; border: 1px solid #444;">
                            <script>
                                document.getElementById('preview-image').addEventListener('error', function () {
                                    if (this.dataset.failed) return;
                                    this.dataset.failed = true;
                                    this.src = this.getAttribute('data-fallback');
                                });
                            </script>
                        </div>
                        {% endif %}
                        <input type="file" name="image" accept="image/*" class="file-input"
                            style="width: 100%; padding: 0.8rem; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                        {% if not product %}
                        <small style="color: #e74c3c; display:block; margin-top:5px;">* å¿…é ˆä¸Šå‚³åœ–ç‰‡</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Name -->
                <div class="form-grid">
                    <div class="form-label">å•†å“åç¨± <span class="required">*</span></div>
                    <div>
                        <input type="text" name="name" value="{{ product.name if product else '' }}" required
                            style="width: 100%; padding: 0.8rem; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                    </div>
                </div>

                <!-- ID -->
                <div class="form-grid">
                    <div class="form-label">å•†å“ä»£è™Ÿ (ID) <span class="required">*</span></div>
                    <div>
                        <input type="text" name="id" value="{{ product.id if product else '' }}" required
                            style="width: 100%; padding: 0.8rem; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;"
                            {% if product %}readonly{% endif %}>
                        <small style="color: #666; display: block; margin-top: 5px;">å”¯ä¸€è­˜åˆ¥ç¢¼ (ä¾‹: keychain)</small>
                    </div>
                </div>

                <!-- Desc -->
                <div class="form-grid">
                    <div class="form-label">å•†å“æè¿° <span class="required">*</span></div>
                    <div>
                        <textarea name="desc" rows="5" required
                            style="width: 100%; padding: 0.8rem; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">{{ product.desc if product else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Section: Sales Settings -->
            <div class="admin-section">
                <h3>éŠ·å”®è¨­å®š (Sales Info)</h3>

                <!-- Pricing Row -->
                <div class="form-grid">
                    <div class="form-label">åƒ¹æ ¼è¨­å®š <span class="required">*</span></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Price -->
                        <div
                            style="display: flex; align-items: center; background: #1a1a1f; border: 1px solid #333; border-radius: 5px;">
                            <span
                                style="padding: 0.8rem; background: #222; color: #888; border-right: 1px solid #333;">å”®åƒ¹
                                $</span>
                            <input type="text" name="price"
                                value="{{ (product.price or '') | replace('NT$ ', '') | replace('NT$', '') }}" required
                                placeholder="100"
                                style="flex: 1; padding: 0.8rem; background: transparent; border: none; color: white; outline: none;">
                        </div>
                        <!-- Original Price -->
                        <div
                            style="display: flex; align-items: center; background: #1a1a1f; border: 1px solid #333; border-radius: 5px;">
                            <span
                                style="padding: 0.8rem; background: #222; color: #888; border-right: 1px solid #333;">åŸåƒ¹
                                $</span>
                            <input type="text" name="original_price"
                                value="{{ (product.original_price or '') | replace('NT$ ', '') | replace('NT$', '') }}"
                                placeholder="200"
                                style="flex: 1; padding: 0.8rem; background: transparent; border: none; color: white; outline: none;">
                        </div>
                    </div>
                </div>

                <!-- Discount Label -->
                <div class="form-grid">
                    <div class="form-label">å„ªæƒ æ¨™ç±¤</div>
                    <div>
                        <input type="text" name="discount_label" value="{{ product.discount_label if product else '' }}"
                            placeholder="ä¾‹: æ—©é³¥å„ªæƒ "
                            style="width: 100%; padding: 0.8rem; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                    </div>
                </div>

                <!-- Status Toggles (Moved from Top) -->
                <div class="form-grid">
                    <div class="form-label">å•†å“ç‹€æ…‹</div>
                    <div style="display: flex; gap: 30px;">
                        <!-- Out of Stock -->
                        <div>
                            <label class="switch">
                                <input type="checkbox" name="is_out_of_stock" {% if product and product.is_out_of_stock
                                    %}checked{% endif %}>
                                <span class="slider round red-slider"></span>
                            </label>
                            <span style="margin-left: 10px; color: #aaa;">é¡¯ç¤ºç‚ºã€Œè£œè²¨ä¸­ã€</span>
                        </div>
                        <!-- Recommended -->
                        <div>
                            <label class="switch">
                                <input type="checkbox" name="is_recommended" {% if product and product.sort_order> 0
                                %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                            <span style="margin-left: 10px; color: #aaa;">è¨­ç‚ºã€Œæœ¬æœŸæ¨è–¦ã€</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Advanced Settings -->
            <div class="admin-section">
                <h4
                    style="color: var(--secondary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem;">
                    é€²éšè¨­å®š (Advanced Settings)</h4>

                <!-- Visual Spec Builder -->
                <div class="form-grid">
                    <div class="form-label">å•†å“è¦æ ¼</div>
                    <div>
                        <div id="specs-container"></div>
                        <button type="button" onclick="addSpec()"
                            style="background: rgba(255,255,255,0.1); border: 1px dashed #666; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">+
                            æ–°å¢è¦æ ¼</button>
                        <input type="hidden" name="specs" id="specs-input">
                    </div>
                </div>

                <!-- Visual Variant Builder -->
                <div class="form-grid">
                    <div class="form-label">æ¬¾å¼è®Šé«”</div>
                    <div>
                        <div
                            style="overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 5px; border: 1px solid #333;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                <thead>
                                    <tr
                                        style="background: rgba(255,255,255,0.05); color: #aaa; border-bottom: 1px solid #333;">
                                        <th style="padding: 10px; text-align: left;">æ¬¾å¼åç¨±</th>
                                        <th style="padding: 10px; text-align: left;">åƒ¹æ ¼ (Price)</th>
                                        <th style="padding: 10px; text-align: left;">ç¼ºè²¨?</th>
                                        <th style="padding: 10px; text-align: left;">è¦æ ¼æè¿°</th>
                                        <th style="padding: 10px; text-align: left;">åœ–ç‰‡</th>
                                        <th style="padding: 10px; width: 50px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="variants-container">
                                    <!-- Rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="addVariant()"
                            style="background: rgba(255,255,255,0.1); border: 1px dashed #666; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">+
                            æ–°å¢æ¬¾å¼</button>
                        <input type="hidden" name="variants" id="variants-input">
                    </div>
                </div>

                <!-- Visual Add-on Builder -->
                <div class="form-grid">
                    <div class="form-label">åŠ è³¼é …</div>
                    <div>
                        <div
                            style="overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 5px; border: 1px solid #333;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                <thead>
                                    <tr
                                        style="background: rgba(255,255,255,0.05); color: #aaa; border-bottom: 1px solid #333;">
                                        <th style="padding: 10px; text-align: left;">åç¨±</th>
                                        <th style="padding: 10px; text-align: left;">åƒ¹æ ¼</th>
                                        <th style="padding: 10px; text-align: left;">èªªæ˜</th>
                                        <th style="padding: 10px; width: 50px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="addons-container">
                                    <!-- Rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="addAddon()"
                            style="background: rgba(255,255,255,0.1); border: 1px dashed #666; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">+
                            æ–°å¢åŠ è³¼é …</button>
                        <input type="hidden" name="addons" id="addons-input">
                    </div>
                </div>
            </div>

            <script>
                // Initial Data
                // Use templating to inject JSON string, then parse it. 
                // This prevents IDE syntax errors and handles potential nulls gracefully.
                const specsRaw = '{{ product.specs | replace("\'", "\\\'") | safe if product and product.specs else "[]" }}';
                const variantsRaw = '{{ product.variants | replace("\'", "\\\'") | safe if product and product.variants else "[]" }}';
                const addonsRaw = '{{ product.addons | replace("\'", "\\\'") | safe if product and product.addons else "[]" }}';

                let specsData = [];
                let variantsData = [];
                let addonsData = [];

                try {
                    specsData = JSON.parse(specsRaw);
                } catch (e) {
                    console.error("Error parsing specs JSON", e);
                    specsData = [];
                }

                try {
                    variantsData = JSON.parse(variantsRaw);
                } catch (e) {
                    console.error("Error parsing variants JSON", e);
                    variantsData = [];
                }

                try {
                    addonsData = JSON.parse(addonsRaw);
                } catch (e) {
                    console.error("Error parsing addons JSON", e);
                    addonsData = [];
                }

                const specsContainer = document.getElementById('specs-container');
                const variantsContainer = document.getElementById('variants-container');
                const addonsContainer = document.getElementById('addons-container');

                // Render Specs
                function renderSpecs() {
                    specsContainer.innerHTML = '';
                    specsData.forEach((spec, index) => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '5px';
                        div.style.display = 'flex';
                        div.style.gap = '10px';
                        div.innerHTML = `
                            <input type="text" value="${spec}" onchange="updateSpec(${index}, this.value)" placeholder="ä¾‹å¦‚ï¼šå°ºå¯¸ï¼š10cm" style="flex:1; padding: 8px; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                            <button type="button" onclick="removeSpec(${index})" style="background: #e74c3c; color: white; border: none; padding: 0 10px; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸</button>
                        `;
                        specsContainer.appendChild(div);
                    });
                }

                function addSpec() {
                    specsData.push('');
                    renderSpecs();
                }

                function removeSpec(index) {
                    specsData.splice(index, 1);
                    renderSpecs();
                }

                function updateSpec(index, value) {
                    specsData[index] = value;
                }

                // Render Variants
                function renderVariants() {
                    variantsContainer.innerHTML = '';
                    variantsData.forEach((variant, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="padding: 5px;">
                                <input type="text" value="${variant.name || ''}" onchange="updateVariant(${index}, 'name', this.value)" placeholder="æ¬¾å¼åç¨±" style="width: 100%; padding: 8px; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                            </td>
                            <td style="padding: 5px;">
                                <div style="display: flex; align-items: center; background: #1a1a1f; border: 1px solid #333; border-radius: 5px;">
                                    <span style="padding: 5px 8px; background: #222; color: #666; font-size: 0.8em; border-right: 1px solid #333;">NT$</span>
                                    <input type="text" value="${(variant.price || '').replace('NT$ ', '').replace('NT$', '')}" onchange="updateVariant(${index}, 'price', this.value)" 
                                        placeholder="100" 
                                        style="flex: 1; padding: 8px; background: transparent; border: none; color: white; outline: none; width: 60px;">
                                </div>
                            </td>
                            <td style="padding: 5px;">
                                <div style="display: flex; justify-content: center; align-items: center;">
                                    <input type="checkbox" name="variant_oos_${index}" 
                                        ${variant.is_out_of_stock ? 'checked' : ''}
                                        style="width: 20px; height: 20px; cursor: pointer;">
                                </div>
                            </td>
                            <td style="padding: 5px;">
                                <input type="text" value="${variant.spec_text || ''}" onchange="updateVariant(${index}, 'spec_text', this.value)" placeholder="å°æ‡‰è¦æ ¼" style="width: 100%; padding: 8px; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                            </td>
                            <td style="padding: 5px;">
                                ${variant.image ? `<div style="margin-bottom:5px;"><img src="/static/uploads/${variant.image}" height="40" style="vertical-align:middle; margin-right:5px;"></div>` : ''}
                                <input type="file" class="variant-file-input" data-index="${index}" style="color: #aaa; font-size: 0.9em;">
                                <input type="hidden" value="${variant.image || ''}"> <!-- Keep existing image -->
                            </td>
                            <td style="padding: 5px; text-align: center;">
                                <button type="button" onclick="removeVariant(${index})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸</button>
                            </td>
                        `;
                        variantsContainer.appendChild(tr);
                    });
                }

                function addVariant() {
                    variantsData.push({ name: '', price: '', image: '', spec_text: '' });
                    renderVariants();
                }

                function removeVariant(index) {
                    variantsData.splice(index, 1);
                    renderVariants();
                }

                function updateVariant(index, key, value) {
                    variantsData[index][key] = value;
                }

                // Render Addons
                function renderAddons() {
                    addonsContainer.innerHTML = '';
                    addonsData.forEach((addon, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="padding: 5px;">
                                <input type="text" value="${addon.name || ''}" onchange="updateAddon(${index}, 'name', this.value)" placeholder="åŠ è³¼å“åç¨±" style="width: 100%; padding: 8px; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                            </td>
                            <td style="padding: 5px;">
                                <div style="display: flex; align-items: center; background: #1a1a1f; border: 1px solid #333; border-radius: 5px;">
                                    <span style="padding: 5px 8px; background: #222; color: #666; font-size: 0.8em; border-right: 1px solid #333;">NT$</span>
                                    <input type="text" value="${(addon.price || '').replace('NT$ ', '').replace('NT$', '')}" onchange="updateAddon(${index}, 'price', this.value)" placeholder="100" style="flex: 1; padding: 8px; background: transparent; border: none; color: white; outline: none;">
                                </div>
                            </td>
                            <td style="padding: 5px;">
                                <input type="text" value="${addon.desc || ''}" onchange="updateAddon(${index}, 'desc', this.value)" placeholder="èªªæ˜ (é¸å¡«)" style="width: 100%; padding: 8px; background: #1a1a1f; border: 1px solid #333; color: white; border-radius: 5px;">
                            </td>
                            <td style="padding: 5px; text-align: center;">
                                <button type="button" onclick="removeAddon(${index})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸</button>
                            </td>
                        `;
                        addonsContainer.appendChild(tr);
                    });
                }

                function addAddon() {
                    addonsData.push({ name: '', price: '', desc: '' });
                    renderAddons();
                }

                function removeAddon(index) {
                    addonsData.splice(index, 1);
                    renderAddons();
                }

                function updateAddon(index, key, value) {
                    addonsData[index][key] = value;
                }

                // Initialize
                renderSpecs();
                renderVariants();
                renderAddons();

                // Form Submit Handler
                document.querySelector('form').addEventListener('submit', function (e) {
                    // 1. Serialize Specs
                    document.getElementById('specs-input').value = JSON.stringify(specsData.filter(s => s.trim() !== ''));

                    // 2. Serialize Variants (Text Data)
                    // Note: New images are handled by file inputs. Existing images are preserved in variantsData.
                    // We will allow the backend to merge them.
                    document.getElementById('variants-input').value = JSON.stringify(variantsData);

                    // 3. Serialize Addons
                    document.getElementById('addons-input').value = JSON.stringify(addonsData);

                    // 4. Rename File Inputs to match index order (variant_image_0, variant_image_1...)
                    const fileInputs = document.querySelectorAll('.variant-file-input');
                    fileInputs.forEach(input => {
                        const index = input.dataset.index;
                        input.name = 'variant_image_' + index;
                    });
                });
            </script>

            <!-- Sticky Bottom Action Bar -->
            <div class="action-bar">
                <a href="{{ url_for('admin_products') }}"
                    style="color: #aaa; text-decoration: none; font-weight: bold;">âœ• å–æ¶ˆ</a>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="action" value="hide"
                        style="background: rgba(100,100,100, 0.3); border: 1px solid rgba(255,255,255,0.2); color: #ddd; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        å„²å­˜ä¸¦ä¸‹æ¶
                    </button>
                    <button type="submit" name="action" value="publish"
                        style="background: var(--secondary-color); border: none; color: black; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        å„²å­˜ä¸¦ä¸Šæ¶
                    </button>
                </div>
            </div>

        </form>
    </div>

</section>
{% endblock %}