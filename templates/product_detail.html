{% extends 'base.html' %}

{% block title %}{{ product.name }} - 諾雕 ALE{% endblock %}

{% block content %}
<section style="padding: 120px 10%; min-height: 80vh; display: flex; justify-content: center; align-items: flex-start;">

    <div class="product-detail-card" style="
        background: var(--card-bg); 
        border-radius: 20px; 
        border: var(--glass-border); 
        padding: 3rem; 
        width: 100%; 
        max-width: 900px;
        display: flex;
        flex-wrap: wrap;
        gap: 3rem;
        backdrop-filter: blur(10px);
    ">
        <!-- 模擬圖片區域 (因無真實圖片，用色塊代替) -->
        <div
            style="flex: 1; min-width: 300px; height: 300px; overflow: hidden; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
            <img src="{{ url_for('static', filename='images/' + product.image) }}" alt="{{ product.name }}"
                style="width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s ease;"
                class="img-display {% if product.is_out_of_stock %}out-of-stock-filter{% endif %}">

            <style>
                .out-of-stock-filter {
                    opacity: 0.5;
                    filter: grayscale(100%);
                }
            </style>

            {% if product.is_out_of_stock %}
            <div style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-15deg);
                background: rgba(231, 76, 60, 0.9);
                color: white;
                padding: 10px 30px;
                font-size: 2rem;
                font-weight: bold;
                border: 2px solid white;
                border-radius: 5px;
                white-space: nowrap;
                pointer-events: none;
                z-index: 10;
            ">SOLD OUT</div>
            {% endif %}
        </div>

        <div style="flex: 1; min-width: 300px;">
            <h2 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--primary-color);">{{ product.name }}</h2>
            <div
                style="font-size: 2rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 1.5rem; display: flex; align-items: baseline; flex-wrap: wrap; gap: 1rem;">
                {% if product.original_price %}
                <span style="text-decoration: line-through; color: #666; font-size: 1.5rem;">{{ product.original_price
                    }}</span>
                {% endif %}

                <span id="product-price">{{ product.price }}</span>

                {% if product.discount_label %}
                <span style="
                    font-size: 0.9rem; 
                    background: rgba(46, 204, 113, 0.2); 
                    color: #2ecc71; 
                    padding: 0.3rem 0.8rem; 
                    border-radius: 20px; 
                    border: 1px solid #2ecc71;
                    vertical-align: middle;
                ">
                    {{ product.discount_label }}
                </span>
                {% endif %}
            </div>

            <p style="margin-bottom: 2rem; line-height: 1.8; color: rgba(255,255,255,0.9);">
                {{ product.desc }}
            </p>

            {% if product.addons %}
            <div
                style="margin-bottom: 2rem; background: rgba(0,255,100,0.05); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(0,255,100,0.2);">
                <h4 style="margin-bottom: 1rem; color: #2ecc71;">加購項目 (Add-ons)：</h4>
                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    {% for addon in product.addons %}
                    <label
                        style="display: flex; align-items: center; cursor: pointer; padding: 0.8rem; background: rgba(0,0,0,0.3); border-radius: 8px; transition: background 0.3s;"
                        onmouseover="this.style.background='rgba(0,0,0,0.5)'"
                        onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                        <input type="checkbox" class="addon-checkbox" value="{{ addon.name }}"
                            data-price="{{ addon.price }}"
                            style="width: 1.2rem; height: 1.2rem; margin-right: 1rem; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.2rem;">
                                <strong style="color: white; font-size: 1rem;">{{ addon.name }}</strong>
                                <span style="color: #2ecc71; font-weight: bold;">{{ addon.price }}</span>
                            </div>
                            <small style="color: #aaa; font-size: 0.85rem;">{{ addon.desc }}</small>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if product.variants %}
            <div style="margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--text-color);">選擇款式 (Select Style)：</h4>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    {% for variant in product.variants %}
                    <button class="variant-btn" data-spec="{{ variant.spec_text }}" data-price="{{ variant.price }}"
                        onclick="changeVariant(this, '{{ variant.image }}', '{{ variant.name }}', '{{ variant.price }}', '{{ variant.is_out_of_stock }}')"
                        style="
                            padding: 0.5rem 1.5rem; 
                            border: 1px solid var(--secondary-color); 
                            background: rgba(0,0,0,0.3); 
                            color: white; 
                            border-radius: 5px; 
                            cursor: pointer;
                            transition: all 0.3s;
                            font-family: inherit;
                            {% if variant.is_out_of_stock %}
                            border: 1px dashed #ff6b6b;
                            color: #ff6b6b;
                            {% endif %}
                        ">
                        {{ variant.name }} {% if variant.is_out_of_stock %}(缺貨){% endif %}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div style="margin-bottom: 2rem; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 10px;">
                <h4 style="margin-bottom: 1rem; color: var(--text-color);">產品規格：</h4>
                <ul id="specs-list" style="list-style: none; padding-left: 0;">
                    {% for spec in product.specs %}
                    <li data-original-text="{{ spec }}"
                        style="margin-bottom: 0.5rem; color: rgba(255,255,255,0.7); display: flex; align-items: center;">
                        <span
                            style="display: inline-block; width: 6px; height: 6px; background: var(--secondary-color); border-radius: 50%; margin-right: 10px;"></span>
                        {{ spec }}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <script>
                const defaultImage = "{{ url_for('static', filename='images/' + product.image) }}";
                const defaultPrice = "{{ product.price }}";
                let currentVariant = null;

                function changeVariant(btn, imageName, variantName, variantPrice, isOos) {
                    const imgElement = document.querySelector('.img-display');
                    const priceElement = document.getElementById('product-price');
                    const targetSpec = btn.getAttribute('data-spec');
                    const specsList = document.getElementById('specs-list');
                    const listItems = specsList.querySelectorAll('li');

                    const bookingBtn = document.getElementById('booking-btn');
                    const baseUrl = "{{ url_for('booking') }}?product={{ product.name }}";

                    // If clicking the currently active variant, reset to default (Toggle off)
                    if (currentVariant === variantName) {
                        imgElement.src = defaultImage;
                        priceElement.innerText = defaultPrice;
                        currentVariant = null;

                        // Reset all buttons style
                        document.querySelectorAll('.variant-btn').forEach(b => {
                            b.style.background = 'rgba(0,0,0,0.3)';
                            b.style.color = 'white';
                            b.style.borderColor = 'var(--secondary-color)';
                            b.style.boxShadow = 'none';
                        });

                        // Reset Specs: Show all
                        listItems.forEach(li => {
                            li.style.display = 'flex';
                        });

                        // Reset Booking Link
                        // Reset Booking Link and Style
                        bookingBtn.href = baseUrl;
                        bookingBtn.removeAttribute('target'); // Reset target
                        bookingBtn.classList.remove('disabled');
                        bookingBtn.style.pointerEvents = 'auto';
                        bookingBtn.innerText = '立即預約此產品';
                        bookingBtn.style.background = 'var(--primary-color)';
                        bookingBtn.style.color = 'white';

                        return;
                    }

                    // Otherwise, switch to new variant
                    currentVariant = variantName;

                    // Update Image
                    imgElement.src = "{{ url_for('static', filename='images/') }}" + imageName;
                    imgElement.style.opacity = 0;
                    setTimeout(() => imgElement.style.opacity = 1, 50);

                    // Update Price if variant has specific price
                    if (variantPrice && variantPrice !== 'None' && variantPrice !== '') {
                        priceElement.innerText = variantPrice;
                    } else {
                        priceElement.innerText = defaultPrice;
                    }

                    // Update UI Buttons: Reset others
                    document.querySelectorAll('.variant-btn').forEach(b => {
                        b.style.background = 'rgba(0,0,0,0.3)';
                        b.style.color = 'white';

                        // Keep the red/dashed style if OOS
                        if (b.innerText.includes('(缺貨)')) {
                            b.style.color = '#ff6b6b';
                            b.style.borderColor = '#ff6b6b';
                            b.style.borderStyle = 'dashed';
                        } else {
                            b.style.borderColor = 'var(--secondary-color)';
                            b.style.borderStyle = 'solid';
                        }
                        b.style.boxShadow = 'none';
                    });

                    // Apply Active Style
                    btn.style.background = 'var(--secondary-color)';
                    btn.style.color = 'black';
                    btn.style.boxShadow = '0 0 10px var(--secondary-color)';

                    // Update Specs: Show Common (Index 0) + Target Spec
                    listItems.forEach((li, index) => {
                        // Always show the first item (Common spec)
                        if (index === 0) {
                            li.style.display = 'flex';
                            return;
                        }

                        // For others, check if it matches the target spec
                        const text = li.getAttribute('data-original-text');
                        if (text === targetSpec) {
                            li.style.display = 'flex';
                        } else {
                            li.style.display = 'none';
                        }
                    });

                    // Update Booking Link
                    // Update Booking Link & Check OOS
                    updateBookingLink();

                    if (isOos === 'True' || isOos === 'true' || isOos === true) {
                        // Enable button but change to Contact mode
                        bookingBtn.classList.remove('disabled');
                        bookingBtn.style.pointerEvents = 'auto';
                        bookingBtn.style.background = '#3498db'; // Info Blue
                        bookingBtn.innerText = '此樣式缺貨 - 聯絡詢問 (Contact Us)';
                        bookingBtn.href = 'https://x.com/arnold__laser'; // Social Link
                        bookingBtn.target = '_blank';
                    } else {
                        bookingBtn.classList.remove('disabled');
                        bookingBtn.removeAttribute('target');
                        bookingBtn.style.pointerEvents = 'auto';
                        bookingBtn.style.background = 'var(--primary-color)';
                        bookingBtn.innerText = '立即預約此產品';
                    }
                }

                function updateBookingLink() {
                    const bookingBtn = document.getElementById('booking-btn');
                    const baseUrl = "{{ url_for('booking') }}?product={{ product.name }}";
                    let finalUrl = baseUrl;

                    // Append Variant
                    if (currentVariant) {
                        finalUrl += "&variant=" + encodeURIComponent(currentVariant);
                    }

                    // Append Addons
                    const selectedAddons = [];
                    document.querySelectorAll('.addon-checkbox:checked').forEach(cb => {
                        selectedAddons.push(cb.value);
                    });

                    if (selectedAddons.length > 0) {
                        // Pass addons as a generic note or a specific param if booking supports it.
                        // Ideally, we pass it as 'notes' preamble or a new param.
                        // Let's pass it as 'addons' param
                        finalUrl += "&addons=" + encodeURIComponent(selectedAddons.join(', '));
                    }

                    bookingBtn.href = finalUrl;
                }

                // Add event listeners for addons
                document.addEventListener('DOMContentLoaded', () => {
                    document.querySelectorAll('.addon-checkbox').forEach(cb => {
                        cb.addEventListener('change', updateBookingLink);
                    });
                });
            </script>

            {% if product.is_out_of_stock %}
            <button class="btn btn-primary" disabled
                style="width: 100%; text-align: center; background: #555; cursor: not-allowed; border-color: #555;">
                商品暫時缺貨 (Out of Stock)
            </button>
            {% else %}
            <a id="booking-btn" href="{{ url_for('booking') }}?product={{ product.name }}" class="btn btn-primary"
                style="width: 100%; text-align: center;">立即預約此產品</a>
            {% endif %}

            <div style="text-align: center; margin-top: 1rem;">
                <a href="{{ url_for('guidelines') }}"
                    style="font-size: 0.9rem; color: var(--secondary-color); text-decoration: underline;">
                    ⚠ 送印檔案規範 (File Guidelines)
                </a>
            </div>
            <a href="{{ url_for('products') }}"
                style="display: block; text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5); text-decoration: none;">←
                返回產品列表</a>
        </div>
    </div>

</section>
{% endblock %}